# Maintainer: pg9182 <96569817+pg9182@users.noreply.github.com>
pkgname=northstar-dedicated-wine
pkgver=10.0
pkgrel=0
pkgdesc="Patched Wine build for the Northstar dedicated server"

url="https://www.winehq.org"
license="LGPL-2.0-or-later"

arch="x86_64"
provides="wine=${pkgver}"
subpackages="$pkgname-dev $pkgname-doc"
depends_dev="$pkgname perl"
makedepends="autoconf automake bison flex gnutls-dev libxi-dev mingw-w64-gcc mingw-w64-binutils linux-headers"

# note: I've disabled the CreateWindow patch (which was to remove the need for
# X11 to run the dedicated server) since it seems to cause time to slow down
# in-game (possibly caused by the 6+ repeated calls to PeekMessage for the
# window handle in-between ticks). This will need more debugging later.

options="textrels !check"
source="https://dl.winehq.org/wine/source/10.0/wine-$pkgver.tar.xz"

builddir="$srcdir/wine-$pkgver"

build() {}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 tools/wineapploader \
		"$pkgdir"/usr/bin/wineapploader

	local file
	for file in msiexec notepad regedit regsvr32 wineboot \
		winecfg wineconsole winefile winemine winepath
	do
		if rm "$pkgdir"/usr/bin/$file; then
			ln -sf /usr/bin/wineapploader "$pkgdir"/usr/bin/$file
		fi
	done
}

dev() {
	default_dev

	install -d "$subpkgdir"/usr/bin

	local file
	for file in widl wmc wrc winebuild winedump function_grep.pl \
		 winedbg winemaker winegcc winecpp wineg++
	do
		mv "$pkgdir"/usr/bin/$file "$subpkgdir"/usr/bin/ || true
	done
}

doc() {
	default_doc
	rm -fr "$subpkgdir"/usr/share/man/*.UTF-8
}

sha512sums="effb41c5641993e2e52eaa825cc19b7d9846e084992c5a5b066ead2339b24384d320898a9cee347a9a87106bcb3b0f54c8cd2c8d4de3a887a658052ddd5168d6  wine-10.0.tar.xz"
