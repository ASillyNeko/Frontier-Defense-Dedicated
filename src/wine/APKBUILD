# Maintainer: pg9182 <96569817+pg9182@users.noreply.github.com>
pkgname=northstar-dedicated-wine
pkgver=10.0
pkgrel=0
pkgdesc="Patched Wine build for the Northstar dedicated server"

url="https://www.winehq.org"
license="LGPL-2.0-or-later"

arch="x86_64"
provides="wine=${pkgver}"
subpackages="$pkgname-dev $pkgname-doc"
depends_dev="$pkgname perl"
makedepends="autoconf automake bison flex gnutls-dev libxi-dev mingw-w64-gcc mingw-w64-binutils linux-headers"

# note: I've disabled the CreateWindow patch (which was to remove the need for
# X11 to run the dedicated server) since it seems to cause time to slow down
# in-game (possibly caused by the 6+ repeated calls to PeekMessage for the
# window handle in-between ticks). This will need more debugging later.

options="textrels !check"
source="https://dl.winehq.org/wine/source/10.0/wine-$pkgver.tar.xz"
#	rpath.patch
#	winemenubuilder.patch
#	ws2siobacklogquery.patch
#	wine-mr-1034.patch
#	createwindow.patch

builddir="$srcdir/wine-$pkgver"

build() {
    local _win64 _no_pie
    case "$CARCH" in
        x86_64) _win64=--enable-win64 ;;
        x86) _no_pie="-no-pie" ;;
    esac

    ./configure \
        --build="$CBUILD" \
        --host="$CHOST" \
        --prefix=/usr \
        --libdir=/usr/lib \
        --sysconfdir=/etc \
        --localstatedir=/var \
        \
        --without-alsa \
        --without-capi \
        --without-coreaudio \
        --without-cups \
        --without-dbus \
        --without-fontconfig \
        --without-freetype \
        --without-gphoto \
        --without-gssapi \
        --without-gstreamer \
        --without-krb5 \
        --without-ldap \
        --without-openal \
        --without-opencl \
        --without-opengl \
        --without-osmesa \
        --without-oss \
        --without-pcap \
        --without-pulse \
        --without-sane \
        --without-sdl \
        --without-udev \
        --without-usb \
        --without-v4l2 \
        --without-vkd3d \
        --without-vulkan \
        --without-xcomposite \
        --without-xcursor \
        --without-xfixes \
        --without-xinerama \
        --without-xinput \
        --with-xinput2 \
        --without-xrandr \
        --without-xrender \
        --without-xshape \
        --without-xshm \
        --without-xxf86vm \
        \
        --with-mingw \
        $_win64

    make LDFLAGS="$LDFLAGS $_no_pie" \
        tools/widl/widl \
        tools/winebuild/winebuild \
        tools/winegcc/winegcc \
        tools/wrc/wrc

    make
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 tools/wineapploader \
		"$pkgdir"/usr/bin/wineapploader

	local file
	for file in msiexec notepad regedit regsvr32 wineboot \
		winecfg wineconsole winefile winemine winepath
	do
		if rm "$pkgdir"/usr/bin/$file; then
			ln -sf /usr/bin/wineapploader "$pkgdir"/usr/bin/$file
		fi
	done
}

dev() {
	default_dev

	install -d "$subpkgdir"/usr/bin

	local file
	for file in widl wmc wrc winebuild winedump function_grep.pl \
		 winedbg winemaker winegcc winecpp wineg++
	do
		mv "$pkgdir"/usr/bin/$file "$subpkgdir"/usr/bin/ || true
	done
}

doc() {
	default_doc
	rm -fr "$subpkgdir"/usr/share/man/*.UTF-8
}

sha512sums="
effb41c5641993e2e52eaa825cc19b7d9846e084992c5a5b066ead2339b24384d320898a9cee347a9a87106bcb3b0f54c8cd2c8d4de3a887a658052ddd5168d6  wine-10.0.tar.xz"
#1f023ec35610d7f39eee5ee8e53abf8905509dd37513a1ec00f498e5e28890c60555d43daeae28b806879050b3422575f3552fa338177e923b0471c89418a607  rpath.patch
#eaaa991510d6de7f33ea8d81954737ab4a18f40675f3fa5822367fe40e439880246209d913f646e80e1120d59fcedaf97d069cf1b203c0d7d032bc8b07faa29d  winemenubuilder.patch
#bf1630e4f8aab6b220eb95beafe2891549bb6d7be17aed9bbd1269409fd589f05fc9b68c123d58cdfc5eff60d53518b232c59b6c4648b7c6e36a2416f4913d33  ws2siobacklogquery.patch
#caa47044e6caa5edb3f55596bfcc96c0e6166a7d84bc66e13813a1665e27b15524ac4db3bc354d89491d0ba2e8356075141fc21e21662d1469843699e9088da1  wine-mr-1034.patch
#996a6fcf19875b170eb51ccd6f4e5ec32f77326a7ab8c6227c0fa4e3acacf9330efeafdb77de17a176e73d1ec7f58cac3293302833284ce805b6b5e751f9615e  createwindow.patch
